<!-- admin/dashboard.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Farmacia Mery Salud</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #f5f5f5;
        }
        
        .sidebar {
            background: #343a40;
            min-height: 100vh;
            padding: 20px 0;
            position: fixed;
            width: 16.666667%;
        }
        
        .sidebar .nav-link {
            color: #adb5bd;
            padding: 10px 20px;
            margin: 5px 0;
            cursor: pointer;
        }
        
        .sidebar .nav-link:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }
        
        .sidebar .nav-link.active {
            color: white;
            background: #007bff;
        }
        
        .top-navbar {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
        }
        
        .content-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .product-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }

        .main-content {
            margin-left: 16.666667%;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner-border-lg {
            width: 3rem;
            height: 3rem;
        }

        .dashboard-card {
            transition: transform 0.2s;
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="spinner-border spinner-border-lg text-light" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="text-white mt-3">Cargando Dashboard...</p>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 p-0 sidebar">
                <div class="text-center text-white py-3">
                    <i class="fas fa-clinic-medical fa-2x mb-2"></i>
                    <h5>Farmacia Admin</h5>
                </div>
                <nav class="nav flex-column">
                    <a class="nav-link active" href="./dashboard.html">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a class="nav-link" href="./productos.html">
                        <i class="fas fa-pills"></i> Productos
                    </a>
                    <a class="nav-link" href="./pedidos.html">
                        <i class="fas fa-shopping-cart"></i> Pedidos
                    </a>
                    <a class="nav-link" href="./usuarios.html">
                        <i class="fas fa-users"></i> Usuarios
                    </a>
                    <a class="nav-link" href="./perfil.html">
                        <i class="fas fa-user-cog"></i> Mi Perfil
                    </a>
                    <hr class="bg-secondary">
                    <a class="nav-link" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 main-content pt-4">
                <!-- Top Bar -->
                <div class="top-navbar">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1 class="h3 mb-3 fw-bold">
                            <i class="fas fa-tachometer-alt text-primary"></i> Dashboard Administrativo
                        </h1>
                        <div>
                            <span class="badge bg-secondary">
                                <i class="fas fa-user"></i> <span id="adminName">Admin</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="p-4">
                    <!-- Stats Cards -->
                    <div class="row g-4 mb-4">
                        <!-- Total Productos -->
                        <div class="col-xl-3 col-md-6">
                            <div class="card dashboard-card text-white bg-primary">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="text-white-50 small">Total Productos</div>
                                            <div class="h4 fw-bold" id="totalProductos">-</div>
                                        </div>
                                        <div class="icon">
                                            <i class="fas fa-pills fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-primary bg-opacity-25">
                                    <a href="./productos.html" class="text-white text-decoration-none">
                                        Ver todos <i class="fas fa-arrow-right"></i>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Total Pedidos -->
                        <div class="col-xl-3 col-md-6">
                            <div class="card dashboard-card text-white bg-success">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="text-white-50 small">Total Pedidos</div>
                                            <div class="h4 fw-bold" id="totalPedidos">-</div>
                                        </div>
                                        <div class="icon">
                                            <i class="fas fa-box fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-success bg-opacity-25">
                                    <a href="./pedidos.html" class="text-white text-decoration-none">
                                        Ver todos <i class="fas fa-arrow-right"></i>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Pedidos Pendientes -->
                        <div class="col-xl-3 col-md-6">
                            <div class="card dashboard-card text-white bg-warning">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="text-dark small">Pedidos Pendientes</div>
                                            <div class="h4 fw-bold text-dark" id="pedidosPendientes">-</div>
                                        </div>
                                        <div class="icon">
                                            <i class="fas fa-clock fa-2x text-dark"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-warning bg-opacity-25">
                                    <a href="./pedidos.html?estado=PENDIENTE" class="text-dark text-decoration-none">
                                        Ver pendientes <i class="fas fa-arrow-right"></i>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Total Usuarios -->
                        <div class="col-xl-3 col-md-6">
                            <div class="card dashboard-card text-white bg-info">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="text-white-50 small">Total Usuarios</div>
                                            <div class="h4 fw-bold" id="totalUsuarios">-</div>
                                        </div>
                                        <div class="icon">
                                            <i class="fas fa-users fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-info bg-opacity-25">
                                    <a href="./usuarios.html" class="text-white text-decoration-none">
                                        Ver todos <i class="fas fa-arrow-right"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reportes Section -->
                    <div class="row g-4 mb-4">
                        <div class="col-12">
                            <div class="card dashboard-card">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-chart-line text-success"></i> Generación de Reportes
                                    </h5>
                                    <small class="text-muted">Selecciona una fecha y genera reportes de ventas</small>
                                </div>
                                <div class="card-body">
                                    <!-- Selector de Fecha y Botones -->
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-4">
                                            <label for="reporteFecha" class="form-label">
                                                <i class="fas fa-calendar-alt"></i> Seleccionar Fecha
                                            </label>
                                            <input type="date" class="form-control" id="reporteFecha">
                                        </div>
                                        <div class="col-md-8 d-flex align-items-end gap-2">
                                            <button type="button" class="btn btn-success" id="btnGenerarDiario">
                                                <i class="fas fa-file-excel"></i> Reporte Diario
                                            </button>
                                            <button type="button" class="btn btn-primary" id="btnGenerarSemanal">
                                                <i class="fas fa-file-excel"></i> Reporte Semanal
                                            </button>
                                            <button type="button" class="btn btn-outline-info" id="btnVerReportes">
                                                <i class="fas fa-list"></i> Ver Reportes Recientes
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Información de Reportes -->
                                    <div class="alert alert-info" id="reportesInfo">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Información:</strong> Los reportes incluyen solo pedidos entregados.
                                        El reporte diario muestra ganancias de un día específico.
                                        El reporte semanal abarca desde el lunes hasta el domingo de la semana seleccionada.
                                    </div>

                                    <!-- Reportes Recientes -->
                                    <div id="reportesRecientesSection" style="display: none;">
                                        <h6 class="mb-3">
                                            <i class="fas fa-history"></i> Reportes Recientes
                                        </h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Tipo</th>
                                                        <th>Período</th>
                                                        <th>Generado</th>
                                                        <th>Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="reportesRecientesTable">
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">
                                                            <div class="spinner-border spinner-border-sm" role="status">
                                                                <span class="visually-hidden">Cargando...</span>
                                                            </div>
                                                            Cargando reportes...
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="row g-4 mb-4">
                        <!-- Pedidos por Estado -->
                        <div class="col-md-6">
                            <div class="card dashboard-card">
                                <div class="card-header bg-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-chart-pie text-primary"></i> Pedidos por Estado
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="estadoPedidosChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Productos con Poco Stock -->
                        <div class="col-md-6">
                            <div class="card dashboard-card">
                                <div class="card-header bg-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-exclamation-triangle text-warning"></i> Productos con Poco Stock
                                    </h5>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="lowStockProducts">
                                        <div class="text-center text-muted">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card dashboard-card">
                                <div class="card-header bg-white">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-history text-info"></i> Pedidos Recientes
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>N° Pedido</th>
                                                    <th>Cliente</th>
                                                    <th>Productos</th>
                                                    <th>Total</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentOrdersTable">
                                                <tr>
                                                    <td colspan="6" class="text-center">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">Cargando...</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../assets/js/api-config.js"></script>
    <script src="../assets/js/data.js"></script>
    <script src="../assets/js/app.js"></script>

    <script>
        
        // Variables globales
        let dashboardData = null;
        let estadoChart = null;

        // Verificar autenticación al cargar
        document.addEventListener('DOMContentLoaded', async function () {
            
            // Verificar sesión
            const token = localStorage.getItem('accessToken');
            const usuario = localStorage.getItem('usuarioActual');
            
            if (!token || !usuario) {
                showNotification('Sesión no encontrada. Redirigiendo al login...', 'warning');
                setTimeout(() => window.location.href = '/login.html', 2000);
                return;
            }

            const userData = JSON.parse(usuario);
            
            // Verificar que sea ADMIN
            if (userData.rol !== 'ADMIN') {
                showNotification('Acceso denegado. Solo administradores pueden acceder a esta sección.', 'danger');
                setTimeout(() => window.location.href = '/index.html', 2000);
                return;
            }

            // Mostrar nombre del admin
            document.getElementById('adminName').textContent = userData.nombre;

            // Establecer fecha por defecto (hoy)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reporteFecha').value = today;

            // Configurar event listeners
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Cargar datos del dashboard
            await loadDashboardData();
        });

        // Mostrar/ocultar loading
        function showLoading(show = true) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Mostrar notificación
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Cargar datos del dashboard
        async function loadDashboardData() {
            try {
                showLoading(true);
                
                dashboardData = await DashboardAPI.getDashboardData();
                
                // Actualizar estadísticas
                loadStats(dashboardData.stats);
                
                // Cargar gráfico de estados
                loadEstadoPedidosChart(dashboardData.stats.pedidosPorEstado);
                
                // Cargar productos con poco stock
                loadLowStockProducts(dashboardData.lowStockProducts);
                
                // Cargar pedidos recientes
                loadRecentOrders(dashboardData.recentOrders);
                
                showLoading(false);
            } catch (error) {
                console.error('✗ Error al cargar dashboard:', error);
                showLoading(false);
                showNotification('Error al cargar el dashboard: ' + error.message, 'danger');
                
                // Mostrar mensaje de error en las secciones
                document.getElementById('lowStockProducts').innerHTML = 
                    '<p class="text-danger">Error al cargar productos</p>';
                document.getElementById('recentOrdersTable').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error al cargar pedidos</td></tr>';
            }
        }

        // Cargar estadísticas
        function loadStats(stats) {
            document.getElementById('totalProductos').textContent = stats.totalProductos || 0;
            document.getElementById('totalPedidos').textContent = stats.totalPedidos || 0;
            document.getElementById('totalUsuarios').textContent = stats.totalUsuarios || 0;
            document.getElementById('pedidosPendientes').textContent = stats.pedidosPorEstado?.PENDIENTE || 0;
        }

        // Cargar gráfico de estados de pedidos
        function loadEstadoPedidosChart(pedidosPorEstado) {
            if (!pedidosPorEstado) return;
            
            const estados = {
                'PENDIENTE': pedidosPorEstado.PENDIENTE || 0,
                'PROCESANDO': pedidosPorEstado.PROCESANDO || 0,
                'ENVIADO': pedidosPorEstado.ENVIADO || 0,
                'ENTREGADO': pedidosPorEstado.ENTREGADO || 0,
                'CANCELADO': pedidosPorEstado.CANCELADO || 0
            };

            const ctx = document.getElementById('estadoPedidosChart').getContext('2d');
            
            // Destruir gráfico anterior si existe
            if (estadoChart) {
                estadoChart.destroy();
            }
            
            estadoChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendiente', 'Procesando', 'Enviado', 'Entregado', 'Cancelado'],
                    datasets: [{
                        data: [
                            estados.PENDIENTE,
                            estados.PROCESANDO,
                            estados.ENVIADO,
                            estados.ENTREGADO,
                            estados.CANCELADO
                        ],
                        backgroundColor: [
                            '#ffc107', // Pendiente - Amarillo
                            '#17a2b8', // Procesando - Azul
                            '#007bff', // Enviado - Azul oscuro
                            '#28a745', // Entregado - Verde
                            '#dc3545'  // Cancelado - Rojo
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Cargar productos con poco stock
        function loadLowStockProducts(productos) {
            const container = document.getElementById('lowStockProducts');

            if (!productos || productos.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay productos con stock bajo</p>';
                return;
            }

            let html = '';
            productos.forEach(producto => {
                const alertClass = producto.stock <= 10 ? 'danger' : 'warning';
                const imagenUrl = producto.imageUrl 
                    ? `../assets/images${producto.imageUrl}` 
                    : 'https://via.placeholder.com/50?text=Sin+Imagen';
                
                html += `
                    <div class="alert alert-${alertClass} d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <img src="${imagenUrl}" 
                                 class="product-img me-3" 
                                 alt="${producto.name}"
                                 onerror="this.src='https://via.placeholder.com/50?text=Error'">
                            <div>
                                <strong>${producto.name}</strong><br>
                                <small>Stock: ${producto.stock} unidades - ${producto.categoria}</small>
                            </div>
                        </div>
                        <a href="./productos.html" class="btn btn-sm btn-outline-${alertClass}">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Formatear fecha desde array
        function formatDate(dateArray) {
            if (!dateArray || dateArray.length < 3) return 'N/A';
            
            const [year, month, day, hour, minute] = dateArray;
            const date = new Date(year, month - 1, day, hour || 0, minute || 0);
            
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            
            return date.toLocaleDateString('es-PE', options);
        }

        // Cargar pedidos recientes
        function loadRecentOrders(pedidos) {
            const tbody = document.getElementById('recentOrdersTable');

            if (!pedidos || pedidos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay pedidos registrados</td></tr>';
                return;
            }

            let html = '';
            pedidos.forEach(pedido => {
                const badgeClass = {
                    'PENDIENTE': 'warning',
                    'PROCESANDO': 'info',
                    'ENVIADO': 'primary',
                    'ENTREGADO': 'success',
                    'CANCELADO': 'danger'
                }[pedido.status] || 'secondary';

                const fecha = formatDate(pedido.createdAt);
                const cantidadProductos = pedido.items?.length || 0;

                // Crear lista de productos (máximo 2 productos + "y X más" si hay más)
                let productosTexto = '';
                if (pedido.items && pedido.items.length > 0) {
                    const primerosProductos = pedido.items.slice(0, 2);
                    productosTexto = primerosProductos.map(item =>
                        item.product?.name || 'Producto'
                    ).join(', ');

                    if (pedido.items.length > 2) {
                        productosTexto += ` y ${pedido.items.length - 2} más`;
                    }
                } else {
                    productosTexto = 'Sin productos';
                }

                html += `
                    <tr>
                        <td><strong>${pedido.numeroPedido}</strong></td>
                        <td>
                            ${pedido.user?.username || 'N/A'}<br>
                            <small class="text-muted">${pedido.user?.email || ''}</small>
                        </td>
                        <td>
                            <div title="${productosTexto}">
                                <small class="text-muted">${productosTexto}</small><br>
                                <span class="badge bg-secondary">${cantidadProductos} item${cantidadProductos !== 1 ? 's' : ''}</span>
                            </div>
                        </td>
                        <td><strong>S/. ${pedido.totalAmount?.toFixed(2) || '0.00'}</strong></td>
                        <td><span class="badge bg-${badgeClass}">${pedido.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="verDetallePedido(${pedido.id})" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Ver detalle de pedido (placeholder)
        function verDetallePedido(pedidoId) {
            showNotification('Redirigiendo a la sección de pedidos...', 'info');
            setTimeout(() => {
                window.location.href = './pedidos.html';
            }, 1000);
        }

        // Logout
        function logout() {
            if (window.App && window.App.confirmAction) {
                window.App.confirmAction('¿Desea cerrar sesión?', () => {
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    localStorage.removeItem('usuarioActual');
                    localStorage.removeItem('userData');
                    sessionStorage.removeItem('adminUser');
                    
                    window.location.href = './index.html';
                });
            } else {
                // Fallback si App no está disponible - usar modal básico
                showConfirmModal('¿Desea cerrar sesión?', () => {
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    localStorage.removeItem('usuarioActual');
                    localStorage.removeItem('userData');
                    sessionStorage.removeItem('adminUser');
                    
                    window.location.href = './index.html';
                });
            }
        }

        // Variables para reportes
        let reportesRecientes = [];

        // Configurar event listeners para reportes
        document.getElementById('btnGenerarDiario').addEventListener('click', generarReporteDiario);
        document.getElementById('btnGenerarSemanal').addEventListener('click', generarReporteSemanal);
        document.getElementById('btnVerReportes').addEventListener('click', toggleReportesRecientes);

        // Generar reporte diario
        async function generarReporteDiario() {
            const fecha = document.getElementById('reporteFecha').value;
            
            if (!fecha) {
                showNotification('Por favor selecciona una fecha', 'warning');
                return;
            }

            try {
                showLoading(true);
                showNotification('Generando reporte diario...', 'info');
                
                await ReporteAPI.exportarReporteDiario(fecha);
                
                showLoading(false);
                showNotification('Reporte diario generado y descargado exitosamente', 'success');
                
                // Recargar reportes recientes
                await cargarReportesRecientes();
                
            } catch (error) {
                showLoading(false);
                console.error('Error generando reporte diario:', error);
                showNotification('Error al generar reporte diario: ' + error.message, 'danger');
            }
        }

        // Generar reporte semanal
        async function generarReporteSemanal() {
            const fechaSeleccionada = document.getElementById('reporteFecha').value;
            
            if (!fechaSeleccionada) {
                showNotification('Por favor selecciona una fecha', 'warning');
                return;
            }

            try {
                showLoading(true);
                showNotification('Generando reporte semanal...', 'info');
                
                // Calcular inicio y fin de semana (lunes a domingo)
                const fecha = new Date(fechaSeleccionada);
                const diaSemana = fecha.getDay(); // 0 = domingo, 1 = lunes, etc.
                
                // Calcular lunes de la semana
                const lunes = new Date(fecha);
                const diffLunes = fecha.getDay() === 0 ? -6 : 1 - fecha.getDay(); // Si es domingo, restar 6 días
                lunes.setDate(fecha.getDate() + diffLunes);
                
                // Calcular domingo de la semana
                const domingo = new Date(lunes);
                domingo.setDate(lunes.getDate() + 6);
                
                // Formatear fechas
                const fechaInicio = lunes.toISOString().split('T')[0];
                const fechaFin = domingo.toISOString().split('T')[0];
                
                // Generar reporte
                const resultado = await ReporteAPI.generarReporteSemanal(fechaInicio, fechaFin);
                
                if (resultado.status === 'SUCCESS' && resultado.reporte) {
                    const reporteId = resultado.reporte.reporteId;
                    
                    // Exportar a Excel
                    await ReporteAPI.exportarReporteSemanal(reporteId);
                    
                    showLoading(false);
                    showNotification('Reporte semanal generado y descargado exitosamente', 'success');
                    
                    // Recargar reportes recientes
                    await cargarReportesRecientes();
                    
                } else {
                    throw new Error(resultado.message || 'Error desconocido');
                }
                
            } catch (error) {
                showLoading(false);
                console.error('Error generando reporte semanal:', error);
                showNotification('Error al generar reporte semanal: ' + error.message, 'danger');
            }
        }

        // Toggle sección de reportes recientes
        function toggleReportesRecientes() {
            const section = document.getElementById('reportesRecientesSection');
            const isVisible = section.style.display !== 'none';
            
            if (!isVisible) {
                // Mostrar y cargar datos
                section.style.display = 'block';
                cargarReportesRecientes();
            } else {
                // Ocultar
                section.style.display = 'none';
            }
        }

        // Cargar reportes recientes
        async function cargarReportesRecientes() {
            try {
                const tbody = document.getElementById('reportesRecientesTable');
                
                // Mostrar loading
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            Cargando reportes...
                        </td>
                    </tr>
                `;
                
                const reportes = await ReporteAPI.getUltimosReportes(10);
                
                if (!reportes.reportes || reportes.reportes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted">
                                <i class="fas fa-inbox"></i> No hay reportes generados aún
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                reportes.reportes.forEach(reporte => {
                    const fechaInicio = new Date(reporte.semanaInicio[0], reporte.semanaInicio[1] - 1, reporte.semanaInicio[2]);
                    const fechaFin = new Date(reporte.semanaFin[0], reporte.semanaFin[1] - 1, reporte.semanaFin[2]);
                    const fechaGenerado = new Date(reporte.generadoEn[0], reporte.generadoEn[1] - 1, reporte.generadoEn[2], 
                                                 reporte.generadoEn[3] || 0, reporte.generadoEn[4] || 0);
                    
                    const periodo = `${fechaInicio.toLocaleDateString('es-PE')} - ${fechaFin.toLocaleDateString('es-PE')}`;
                    const generado = fechaGenerado.toLocaleDateString('es-PE') + ' ' + fechaGenerado.toLocaleTimeString('es-PE', {hour: '2-digit', minute: '2-digit'});
                    
                    html += `
                        <tr>
                            <td>
                                <span class="badge bg-primary">Semanal</span>
                            </td>
                            <td>
                                <small>${periodo}</small>
                            </td>
                            <td>
                                <small class="text-muted">${generado}</small>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-success" 
                                        onclick="descargarReporteSemanal(${reporte.reporteId})"
                                        title="Descargar Excel">
                                    <i class="fas fa-download"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
                
            } catch (error) {
                console.error('Error cargando reportes recientes:', error);
                const tbody = document.getElementById('reportesRecientesTable');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i> Error al cargar reportes
                        </td>
                    </tr>
                `;
            }
        }

        // Descargar reporte semanal existente
        async function descargarReporteSemanal(reporteId) {
            try {
                showNotification('Descargando reporte...', 'info');
                await ReporteAPI.exportarReporteSemanal(reporteId);
                showNotification('Reporte descargado exitosamente', 'success');
            } catch (error) {
                console.error('Error descargando reporte:', error);
                showNotification('Error al descargar reporte: ' + error.message, 'danger');
            }
        }

        // Hacer funciones globales
        window.verDetallePedido = verDetallePedido;
        window.logout = logout;
        window.descargarReporteSemanal = descargarReporteSemanal;

        // Función de fallback para modal de confirmación
        function showConfirmModal(message, callback) {
            // Crear modal básico si Bootstrap está disponible
            if (typeof bootstrap !== 'undefined') {
                const modalHtml = `
                    <div class="modal fade" id="confirmModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Confirmar Acción</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">${message}</div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-primary" id="confirmBtn">Aceptar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                modal.show();
                
                document.getElementById('confirmBtn').onclick = function() {
                    modal.hide();
                    document.getElementById('confirmModal').remove();
                    callback();
                };
                
                document.getElementById('confirmModal').addEventListener('hidden.bs.modal', function() {
                    document.getElementById('confirmModal').remove();
                });
            } else {
                // Fallback a confirm si no hay Bootstrap
                if (confirm(message)) {
                    callback();
                }
            }
        }
    </script>
</body>
</html>