<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pedidos - Farmacia Mery Salud</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f5f5f5;
        }

        .sidebar {
            background: #343a40;
            min-height: 100vh;
            padding: 20px 0;
            position: fixed;
            width: 16.666667%;
        }

        .sidebar .nav-link {
            color: #adb5bd;
            padding: 10px 20px;
            margin: 5px 0;
            cursor: pointer;
        }

        .sidebar .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar .nav-link.active {
            color: white;
            background: #007bff;
        }

        .top-navbar {
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px;
        }

        .content-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .product-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }

        .main-content {
            margin-left: 16.666667%;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="spinner-border spinner-border-lg text-light" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="text-white mt-3">Cargando pedidos...</p>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 p-0 sidebar">
                <div class="text-center text-white py-3">
                    <i class="fas fa-clinic-medical fa-2x mb-2"></i>
                    <h5>Farmacia Admin</h5>
                </div>
                <nav class="nav flex-column">
                    <a class="nav-link" href="./dashboard.html">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a class="nav-link" href="./productos.html">
                        <i class="fas fa-pills"></i> Productos
                    </a>
                    <a class="nav-link active" href="./pedidos.html">
                        <i class="fas fa-shopping-cart"></i> Pedidos
                    </a>
                    <a class="nav-link" href="./usuarios.html">
                        <i class="fas fa-users"></i> Usuarios
                    </a>
                    <a class="nav-link" href="./perfil.html">
                        <i class="fas fa-user-cog"></i> Mi Perfil
                    </a>
                    <hr class="bg-secondary">
                    <a class="nav-link" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <main class="col-md-10 main-content py-4">
                <!-- Page Header -->
                <div class="top-navbar mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-2 fw-bold">
                                <i class="fas fa-box text-success"></i> Gestión de Pedidos
                            </h1>
                            <p class="text-muted mb-0">Monitoreo y administración de todos los pedidos</p>
                        </div>
                        <div>
                            <span class="badge bg-secondary">
                                <i class="fas fa-user"></i> <span id="adminName">Admin</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Filters and Search -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput"
                                placeholder="Buscar por N° pedido o cliente...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="estadoFilter">
                            <option value="">Todos los estados</option>
                            <option value="PENDING">Pendiente</option>
                            <option value="PROCESSING">En Proceso</option>
                            <option value="DELIVERED">Entregado</option>
                            <option value="CANCELLED">Cancelado</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="fechaFilter">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" id="btnClearFilters">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning" id="totalPendientes">0</h3>
                                <small>Pendientes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-info" id="totalProceso">0</h3>
                                <small>En Proceso</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success" id="totalEntregados">0</h3>
                                <small>Entregados</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary" id="totalVentas">S/. 0.00</h3>
                                <small>Total Ventas</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Table -->
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list"></i> Lista de Pedidos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>N° Pedido</th>
                                        <th>Cliente</th>
                                        <th>Teléfono</th>
                                        <th>Fecha</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Repartidor</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="pedidosTable">
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Detalle Pedido -->
    <div class="modal fade" id="detallePedidoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye"></i> Detalle del Pedido
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detallePedidoContent">
                    <!-- Se llenará dinámicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Asignar Repartidor -->
    <div class="modal fade" id="asignarRepartidorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-motorcycle"></i> Asignar Repartidor
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="pedidoIdAsignar">
                    <div class="mb-3">
                        <label class="form-label">Seleccionar Repartidor</label>
                        <select class="form-select" id="selectRepartidor">
                            <option value="">Seleccione un repartidor...</option>
                            <!-- Se llenará dinámicamente con los repartidores disponibles -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmarAsignacion">Asignar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/api-config.js"></script>
    <script src="../assets/js/data.js"></script>
    <script src="../assets/js/app.js"></script>

    <script>
        
        // Variables globales
        let allPedidos = [];
        let filteredPedidos = [];
        let detalleModal;
        let asignarRepartidorModal;

        // Verificar autenticación al cargar
        document.addEventListener('DOMContentLoaded', async function() {
            
            // Verificar sesión
            const token = localStorage.getItem('accessToken');
            const usuario = localStorage.getItem('usuarioActual');
            
            if (!token || !usuario) {
                showNotification('Sesión no encontrada. Redirigiendo al login...', 'warning');
                setTimeout(() => window.location.href = '/login.html', 2000);
                return;
            }

            const userData = JSON.parse(usuario);
            
            // Verificar que sea ADMIN
            if (userData.rol !== 'ADMIN') {
                showNotification('Acceso denegado. Solo administradores pueden acceder a esta sección.', 'danger');
                setTimeout(() => window.location.href = '/index.html', 2000);
                return;
            }

            // Mostrar nombre del admin
            document.getElementById('adminName').textContent = userData.nombre;

            // Inicializar modales
            detalleModal = new bootstrap.Modal(document.getElementById('detallePedidoModal'));
            asignarRepartidorModal = new bootstrap.Modal(document.getElementById('asignarRepartidorModal'));

            // Configurar event listeners
            setupEventListeners();

            // Cargar pedidos desde el backend
            await loadPedidos();

            // Cargar repartidores para el select
            loadRepartidores();
        });

        // Configurar event listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('estadoFilter').addEventListener('change', applyFilters);
            document.getElementById('fechaFilter').addEventListener('change', applyFilters);
            document.getElementById('btnClearFilters').addEventListener('click', clearFilters);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('btnConfirmarAsignacion').addEventListener('click', confirmarAsignacion);
        }

        // Mostrar/ocultar loading
        function showLoading(show = true) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // Mostrar notificación
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Cargar pedidos desde el backend
        async function loadPedidos() {
            try {
                showLoading(true);
                
                allPedidos = await OrderAPI.getAllOrders();
                filteredPedidos = [...allPedidos];
                
                updateStats();
                renderPedidosTable();
                showLoading(false);
            } catch (error) {
                console.error('✗ Error al cargar pedidos:', error);
                showLoading(false);
                
                const tbody = document.getElementById('pedidosTable');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Error al cargar pedidos: ${error.message}
                            <br>
                            <small>Verifica que el backend esté corriendo en http://localhost:8080</small>
                        </td>
                    </tr>
                `;
            }
        }

        // Actualizar estadísticas
        function updateStats() {
            const stats = {
                pendientes: allPedidos.filter(p => p.status === 'PENDING').length,
                proceso: allPedidos.filter(p => p.status === 'PROCESSING').length,
                entregados: allPedidos.filter(p => p.status === 'DELIVERED').length,
                totalVentas: allPedidos.reduce((sum, p) => sum + (p.totalAmount || p.calculatedTotalAmount || 0), 0)
            };

            document.getElementById('totalPendientes').textContent = stats.pendientes;
            document.getElementById('totalProceso').textContent = stats.proceso;
            document.getElementById('totalEntregados').textContent = stats.entregados;
            document.getElementById('totalVentas').textContent = `S/. ${stats.totalVentas.toFixed(2)}`;
        }

        // Aplicar filtros
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const estadoFilter = document.getElementById('estadoFilter').value;
            const fechaFilter = document.getElementById('fechaFilter').value;

            filteredPedidos = allPedidos.filter(pedido => {
                // Filtro de búsqueda
                const matchSearch = !searchTerm ||
                    pedido.numeroPedido.toLowerCase().includes(searchTerm) ||
                    pedido.user.username.toLowerCase().includes(searchTerm) ||
                    pedido.user.email.toLowerCase().includes(searchTerm);

                // Filtro de estado
                const matchEstado = !estadoFilter || pedido.status === estadoFilter;

                // Filtro de fecha
                let matchFecha = true;
                if (fechaFilter) {
                    const pedidoFecha = formatDateArray(pedido.createdAt, 'date-only');
                    matchFecha = pedidoFecha === fechaFilter;
                }

                return matchSearch && matchEstado && matchFecha;
            });

            renderPedidosTable();
        }

        // Renderizar tabla de pedidos
        function renderPedidosTable() {
            const tbody = document.getElementById('pedidosTable');

            if (filteredPedidos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                            No se encontraron pedidos
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredPedidos.map(pedido => {
                const badgeClass = getStatusBadgeClass(pedido.status);
                const statusText = getStatusText(pedido.status);
                const repartidorNombre = pedido.repartidor 
                    ? pedido.repartidor.username 
                    : '<em class="text-muted">Sin asignar</em>';

                return `
                    <tr>
                        <td><strong>${pedido.numeroPedido}</strong></td>
                        <td>${pedido.user.username}</td>
                        <td>
                            <a href="tel:${pedido.user.telefono}" class="text-decoration-none">
                                <i class="fas fa-phone text-success"></i> ${pedido.user.telefono}
                            </a>
                        </td>
                        <td>${formatDateArray(pedido.createdAt)}</td>
                        <td>
                            <span class="badge bg-secondary">${pedido.items.length} items</span>
                        </td>
                        <td><strong>S/. ${(pedido.totalAmount || pedido.calculatedTotalAmount || 0).toFixed(2)}</strong></td>
                        <td>
                            <select class="form-select form-select-sm" 
                                    onchange="cambiarEstado(${pedido.id}, this.value)">
                                <option value="PENDING" ${pedido.status === 'PENDING' ? 'selected' : ''}>Pendiente</option>
                                <option value="PROCESSING" ${pedido.status === 'PROCESSING' ? 'selected' : ''}>En Proceso</option>
                                <option value="DELIVERED" ${pedido.status === 'DELIVERED' ? 'selected' : ''}>Entregado</option>
                                <option value="CANCELLED" ${pedido.status === 'CANCELLED' ? 'selected' : ''}>Cancelado</option>
                            </select>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <span class="${pedido.repartidor ? 'text-info' : 'text-muted'}">
                                    <i class="fas fa-motorcycle"></i> ${repartidorNombre}
                                </span>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="abrirModalAsignarRepartidor(${pedido.id})"
                                        title="Cambiar repartidor">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" 
                                    onclick="verDetalle(${pedido.id})"
                                    title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <a href="tel:${pedido.user.telefono}" class="btn btn-sm btn-outline-success"
                               title="Llamar al cliente">
                                <i class="fas fa-phone"></i>
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Obtener clase de badge según estado
        function getStatusBadgeClass(status) {
            const classes = {
                'PENDING': 'warning',
                'PROCESSING': 'info',
                'DELIVERED': 'success',
                'CANCELLED': 'danger'
            };
            return classes[status] || 'secondary';
        }

        // Obtener texto del estado en español
        function getStatusText(status) {
            const texts = {
                'PENDING': 'Pendiente',
                'PROCESSING': 'En Proceso',
                'DELIVERED': 'Entregado',
                'CANCELLED': 'Cancelado'
            };
            return texts[status] || status;
        }

        // Formatear array de fecha [2025, 11, 9, 0, 16, 46] a string
        function formatDateArray(dateArray, format = 'full') {
            if (!dateArray || dateArray.length < 3) return 'N/A';
            
            const [year, month, day, hour = 0, minute = 0, second = 0] = dateArray;
            
            if (format === 'date-only') {
                // Formato: 2025-11-09 (para comparar con input date)
                return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            }
            
            // Formato: 09/11/2025 00:16
            return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year} ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
        }

        // Cambiar estado del pedido
        async function cambiarEstado(pedidoId, nuevoEstado) {
            const estadoTexto = getStatusText(nuevoEstado);
            
            if (window.App && window.App.confirmAction) {
                window.App.confirmAction(`¿Cambiar estado del pedido a "${estadoTexto}"?`, async () => {
                    try {
                        showLoading(true);
                        
                        await OrderAPI.updateOrderStatus(pedidoId, nuevoEstado);
                        
                        showLoading(false);
                        showNotification(`Estado actualizado a ${estadoTexto}`, 'success');
                        
                        // Recargar pedidos
                        await loadPedidos();
                    } catch (error) {
                        console.error('Error al cambiar estado:', error);
                        showLoading(false);
                        showNotification('Error al actualizar estado: ' + error.message, 'danger');
                        
                        // Recargar para revertir cambios
                        await loadPedidos();
                    }
                }, () => {
                    // Cancelar: revertir el select
                    loadPedidos();
                });
            } else {
                // Fallback si App no está disponible - usar modal básico
                showConfirmModal(`¿Cambiar estado del pedido a "${estadoTexto}"?`, async () => {
                    try {
                        showLoading(true);
                        
                        await OrderAPI.updateOrderStatus(pedidoId, nuevoEstado);
                        
                        showLoading(false);
                        showNotification(`Estado actualizado a ${estadoTexto}`, 'success');
                        
                        // Recargar pedidos
                        await loadPedidos();
                    } catch (error) {
                        console.error('Error al cambiar estado:', error);
                        showLoading(false);
                        showNotification('Error al actualizar estado: ' + error.message, 'danger');
                        
                        // Recargar para revertir cambios
                        await loadPedidos();
                    }
                }, () => {
                    // Cancelar: revertir el select
                    loadPedidos();
                });
            }
        }

        // Ver detalle del pedido
        async function verDetalle(pedidoId) {
            try {
                showLoading(true);
                
                const pedido = await OrderAPI.getOrderById(pedidoId);
                
                showLoading(false);
                
                const content = document.getElementById('detallePedidoContent');

                let productosHtml = '';
                pedido.items.forEach(item => {
                    productosHtml += `
                        <tr>
                            <td>${item.product.name}</td>
                            <td class="text-center">${item.quantity}</td>
                            <td class="text-end">S/. ${item.price.toFixed(2)}</td>
                            <td class="text-end"><strong>S/. ${item.subtotal.toFixed(2)}</strong></td>
                        </tr>
                    `;
                });

                const badgeClass = getStatusBadgeClass(pedido.status);
                const statusText = getStatusText(pedido.status);

                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle"></i> Información del Pedido</h6>
                            <table class="table table-sm">
                                <tr><th>N° Pedido:</th><td>${pedido.numeroPedido}</td></tr>
                                <tr><th>Fecha:</th><td>${formatDateArray(pedido.createdAt)}</td></tr>
                                <tr><th>Estado:</th><td><span class="badge bg-${badgeClass}">${statusText}</span></td></tr>
                                <tr><th>Total:</th><td><strong>S/. ${(pedido.totalAmount || pedido.calculatedTotalAmount).toFixed(2)}</strong></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-user"></i> Información del Cliente</h6>
                            <table class="table table-sm">
                                <tr><th>Nombre:</th><td>${pedido.user.username}</td></tr>
                                <tr><th>Email:</th><td>${pedido.user.email}</td></tr>
                                <tr><th>Teléfono:</th><td>
                                    <a href="tel:${pedido.user.telefono}">${pedido.user.telefono}</a>
                                </td></tr>
                                <tr><th>Repartidor:</th><td>${pedido.repartidor ? pedido.repartidor.username : '<em class="text-muted">Sin asignar</em>'}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <h6 class="mt-4"><i class="fas fa-map-marker-alt"></i> Dirección de Envío</h6>
                    <p class="mb-1"><strong>Dirección:</strong> ${pedido.shippingAddress || 'No especificada'}</p>
                    <p class="mb-1"><strong>Distrito:</strong> ${pedido.shippingDistrict || 'No especificado'}</p>
                    <p class="mb-3"><strong>Referencia:</strong> ${pedido.shippingReference || 'Sin referencia'}</p>
                    
                    <h6 class="mt-4"><i class="fas fa-pills"></i> Productos del Pedido</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productosHtml}
                            </tbody>
                            <tfoot>
                                <tr class="table-success">
                                    <th colspan="3" class="text-end">TOTAL:</th>
                                    <th class="text-end">S/. ${(pedido.totalAmount || pedido.calculatedTotalAmount).toFixed(2)}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;

                detalleModal.show();
            } catch (error) {
                console.error('Error al obtener detalle:', error);
                showLoading(false);
                showNotification('Error al cargar detalle del pedido: ' + error.message, 'danger');
            }
        }

        // Cargar lista de repartidores
        async function loadRepartidores() {
            try {
                // Usar endpoint correcto con autenticación
                const repartidores = await OrderAPI.getAvailableDeliveryUsers();
                
                const select = document.getElementById('selectRepartidor');
                select.innerHTML = '<option value="">Seleccione un repartidor...</option>';
                
                repartidores.forEach(repartidor => {
                    const option = document.createElement('option');
                    option.value = repartidor.id;
                    option.textContent = repartidor.username;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error al cargar repartidores:', error);
                showNotification('Error al cargar lista de repartidores', 'danger');
                
                // Limpiar el select si hay error
                const select = document.getElementById('selectRepartidor');
                select.innerHTML = '<option value="">Error al cargar repartidores</option>';
            }
        }

        // Abrir modal para asignar repartidor
        async function abrirModalAsignarRepartidor(pedidoId) {
            document.getElementById('pedidoIdAsignar').value = pedidoId;
            
            // Cargar lista de repartidores
            await loadRepartidores();
            
            // Buscar el pedido actual para preseleccionar el repartidor si ya tiene uno
            const pedido = allPedidos.find(p => p.id === pedidoId);
            if (pedido && pedido.repartidor) {
                document.getElementById('selectRepartidor').value = pedido.repartidor.id;
            } else {
                document.getElementById('selectRepartidor').value = '';
            }
            
            asignarRepartidorModal.show();
        }

        // Confirmar asignación de repartidor
        async function confirmarAsignacion() {
            const pedidoId = document.getElementById('pedidoIdAsignar').value;
            const repartidorId = document.getElementById('selectRepartidor').value;
            
            if (!repartidorId) {
                showNotification('Por favor seleccione un repartidor', 'warning');
                return;
            }
            
            try {
                showLoading(true);
                
                await OrderAPI.assignDelivery(pedidoId, repartidorId);
                
                showLoading(false);
                asignarRepartidorModal.hide();
                showNotification('Repartidor asignado exitosamente', 'success');
                
                // Recargar pedidos
                await loadPedidos();
            } catch (error) {
                console.error('Error al asignar repartidor:', error);
                showLoading(false);
                showNotification('Error al asignar repartidor: ' + error.message, 'danger');
            }
        }

        // Limpiar filtros
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('estadoFilter').value = '';
            document.getElementById('fechaFilter').value = '';
            applyFilters();
        }

        // Logout
        function logout() {
            if (window.App && window.App.confirmAction) {
                window.App.confirmAction('¿Desea cerrar sesión?', () => {
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    localStorage.removeItem('usuarioActual');
                    localStorage.removeItem('userData');
                    sessionStorage.removeItem('adminUser');
                    
                    window.location.href = '/login.html';
                });
            } else {
                // Fallback si App no está disponible - usar modal básico
                showConfirmModal('¿Desea cerrar sesión?', () => {
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    localStorage.removeItem('usuarioActual');
                    localStorage.removeItem('userData');
                    sessionStorage.removeItem('adminUser');
                    
                    window.location.href = '/login.html';
                });
            }
        }

        // Hacer funciones globales
        window.cambiarEstado = cambiarEstado;
        window.verDetalle = verDetalle;
        window.abrirModalAsignarRepartidor = abrirModalAsignarRepartidor;
        window.confirmarAsignacion = confirmarAsignacion;
        window.logout = logout;

        // Función de fallback para modal de confirmación
        function showConfirmModal(message, callback, cancelCallback) {
            // Crear modal básico si Bootstrap está disponible
            if (typeof bootstrap !== 'undefined') {
                const modalHtml = `
                    <div class="modal fade" id="confirmModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Confirmar Acción</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">${message}</div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-primary" id="confirmBtn">Aceptar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                modal.show();
                
                document.getElementById('confirmBtn').onclick = function() {
                    modal.hide();
                    document.getElementById('confirmModal').remove();
                    if (callback) callback();
                };
                
                document.getElementById('confirmModal').addEventListener('hidden.bs.modal', function() {
                    document.getElementById('confirmModal').remove();
                    if (cancelCallback) cancelCallback();
                });
            } else {
                // Fallback a confirm si no hay Bootstrap
                if (confirm(message)) {
                    if (callback) callback();
                } else {
                    if (cancelCallback) cancelCallback();
                }
            }
        }
    </script>
</body>
</html>