<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pedidos - Farmacia Mery Salud</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <style>
        body {
            background-color: #f5f5f5;
        }

        .sidebar {
            background: #343a40;
            min-height: 100vh;
            padding: 20px 0;
        }

        .sidebar .nav-link {
            color: #adb5bd;
            padding: 10px 20px;
            margin: 5px 0;
        }

        .sidebar .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar .nav-link.active {
            color: white;
            background: #007bff;
        }

        .top-navbar {
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px;
        }

        .content-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .product-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <!-- Navbar Admin -->
        <div class="row">
            <div class="col-md-2 p-0 sidebar">
                <div class="text-center text-white py-3">
                    <i class="fas fa-clinic-medical fa-2x mb-2"></i>
                    <h5>Farmacia Admin</h5>
                </div>
                <nav class="nav flex-column">
                    <a class="nav-link" href="./dashboard.html">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a class="nav-link" href="./productos.html">
                        <i class="fas fa-pills"></i> Productos
                    </a>
                    <a class="nav-link active" href="./pedidos.html">
                        <i class="fas fa-shopping-cart"></i> Pedidos
                    </a>
                    <a class="nav-link" href="./usuarios.html">
                        <i class="fas fa-users"></i> Usuarios
                    </a>
                    <a class="nav-link" href="./perfil.html">
                        <i class="fas fa-user-cog"></i> Mi Perfil
                    </a>
                    <hr class="bg-secondary">
                    <a class="nav-link" href="#" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </a>
                </nav>
            </div>


            <!-- Main Content -->
            <main class="container-fluid py-4">
                <!-- Page Header -->
                <div class="top-navbar mb-3">
                    <div class="col">
                        <h1 class="h3 mb-3 fw-bold">
                            <i class="fas fa-box text-success"></i> Gestión de Pedidos
                        </h1>
                        <p class="text-muted">Monitoreo y administración de todos los pedidos</p>
                    </div>
                </div>

                <!-- Filters and Search -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" id="searchInput"
                                placeholder="Buscar por N° pedido o cliente...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="estadoFilter">
                            <option value="">Todos los estados</option>
                            <option value="PENDIENTE">Pendiente</option>
                            <option value="EN_PROCESO">En Proceso</option>
                            <option value="ENTREGADO">Entregado</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="fechaFilter">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning" id="totalPendientes">0</h3>
                                <small>Pendientes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-info" id="totalProceso">0</h3>
                                <small>En Proceso</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success" id="totalEntregados">0</h3>
                                <small>Entregados</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary" id="totalVentas">S/. 0.00</h3>
                                <small>Total Ventas</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Table -->
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list"></i> Lista de Pedidos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>N° Pedido</th>
                                        <th>Cliente</th>
                                        <th>Teléfono</th>
                                        <th>Fecha</th>
                                        <th>Productos</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Repartidor</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="pedidosTable">
                                    <!-- Se llenará dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Detalle Pedido -->
    <div class="modal fade" id="detallePedidoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye"></i> Detalle del Pedido
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detallePedidoContent">
                    <!-- Se llenará dinámicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- <script src="../assets/js/data.js"></script> -->
    <!-- <script src="../assets/js/app.js"></script> -->

    <script>
        let allPedidos = [];
        let filteredPedidos = [];

        document.addEventListener('DOMContentLoaded', function () {
            checkAdminAuth();
            loadPedidos();
            setupEventListeners();
        });

        function checkAdminAuth() {
            // const adminUser = JSON.parse(sessionStorage.getItem('adminUser') || 'null');

            // if (!adminUser || adminUser.rol !== 'ADMIN') {
            //     window.location.href = './index.html';
            //     return;
            // }

            // document.getElementById('adminName').textContent = adminUser.nombre;
        }

        function setupEventListeners() {
            // Filtros en tiempo real
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('estadoFilter').addEventListener('change', applyFilters);
            document.getElementById('fechaFilter').addEventListener('change', applyFilters);
        }

        function loadPedidos() {
    // Datos por defecto para demostración
    const defaultData = {
        pedidos: [
            {
                id: 1,
                numero: "ORD-001",
                clienteNombre: "María García",
                telefono: "999888777",
                direccion: "Av. Brasil 123, Breña",
                productos: [
                    {id: 1, nombre: "Paracetamol 500mg", cantidad: 2, precio: 5.50, subtotal: 11.00},
                    {id: 3, nombre: "Vitamina C 1000mg", cantidad: 1, precio: 12.00, subtotal: 12.00}
                ],
                total: 23.00,
                estado: "PENDIENTE",
                fecha: "2024-12-20 10:30"
            },
            {
                id: 2,
                numero: "ORD-002",
                clienteNombre: "Carlos Mendoza",
                telefono: "987654321",
                direccion: "Jr. Lampa 456, Cercado de Lima",
                productos: [
                    {id: 5, nombre: "Alcohol 70°", cantidad: 2, precio: 6.00, subtotal: 12.00}
                ],
                total: 12.00,
                estado: "EN_PROCESO",
                fecha: "2024-12-20 11:15"
            },
            {
                id: 3,
                numero: "ORD-003",
                clienteNombre: "Ana López",
                telefono: "945123789",
                direccion: "Av. Universitaria 1245, San Miguel",
                productos: [
                    {id: 2, nombre: "Ibuprofeno 400mg", cantidad: 1, precio: 8.00, subtotal: 8.00},
                    {id: 7, nombre: "Mascarillas KN95", cantidad: 10, precio: 2.00, subtotal: 20.00}
                ],
                total: 28.00,
                estado: "ENTREGADO",
                fecha: "2024-12-20 09:00"
            },
            {
                id: 4,
                numero: "ORD-004",
                clienteNombre: "Roberto Silva",
                telefono: "912345678",
                direccion: "Av. Arequipa 2890, Lince",
                productos: [
                    {id: 8, nombre: "Termómetro Digital", cantidad: 1, precio: 25.00, subtotal: 25.00}
                ],
                total: 25.00,
                estado: "PENDIENTE",
                fecha: "2024-12-20 13:45"
            }
        ]
    };

    let data = defaultData;
    
    // Si dataStore está disponible, intentar usar datos reales
    if (typeof dataStore !== 'undefined') {
        try {
            const realData = dataStore.getData();
            if (realData && realData.pedidos && realData.pedidos.length > 0) {
                data = realData;
            }
        } catch (error) {
            console.log('Usando datos por defecto para demostración de pedidos');
        }
    }

    allPedidos = data.pedidos;
    filteredPedidos = [...allPedidos];
    
    updateStats();
    renderPedidosTable();
}

        function updateStats() {
            const stats = {
                pendientes: allPedidos.filter(p => p.estado === 'PENDIENTE').length,
                proceso: allPedidos.filter(p => p.estado === 'EN_PROCESO').length,
                entregados: allPedidos.filter(p => p.estado === 'ENTREGADO').length,
                totalVentas: allPedidos.reduce((sum, p) => sum + p.total, 0)
            };

            document.getElementById('totalPendientes').textContent = stats.pendientes;
            document.getElementById('totalProceso').textContent = stats.proceso;
            document.getElementById('totalEntregados').textContent = stats.entregados;
            document.getElementById('totalVentas').textContent = `S/. ${stats.totalVentas.toFixed(2)}`;
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const estadoFilter = document.getElementById('estadoFilter').value;
            const fechaFilter = document.getElementById('fechaFilter').value;

            filteredPedidos = allPedidos.filter(pedido => {
                // Filtro de búsqueda
                const matchSearch = !searchTerm ||
                    pedido.numero.toLowerCase().includes(searchTerm) ||
                    pedido.clienteNombre.toLowerCase().includes(searchTerm);

                // Filtro de estado
                const matchEstado = !estadoFilter || pedido.estado === estadoFilter;

                // Filtro de fecha
                const matchFecha = !fechaFilter ||
                    pedido.fecha.split(' ')[0] === fechaFilter;

                return matchSearch && matchEstado && matchFecha;
            });

            renderPedidosTable();
        }

        function renderPedidosTable() {
            const tbody = document.getElementById('pedidosTable');

            if (filteredPedidos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                            No se encontraron pedidos
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            filteredPedidos.forEach(pedido => {
                const badgeClass = {
                    'PENDIENTE': 'warning',
                    'EN_PROCESO': 'info',
                    'ENTREGADO': 'success'
                }[pedido.estado] || 'secondary';

                html += `
                    <tr>
                        <td><strong>${pedido.numero}</strong></td>
                        <td>${pedido.clienteNombre}</td>
                        <td>
                            <a href="tel:${pedido.telefono}" class="text-decoration-none">
                                <i class="fas fa-phone text-success"></i> ${pedido.telefono}
                            </a>
                        </td>
                        <td>${pedido.fecha}</td>
                        <td>
                            <span class="badge bg-secondary">${pedido.productos.length} items</span>
                        </td>
                        <td><strong>S/. ${pedido.total.toFixed(2)}</strong></td>
                        <td>
                            <select class="form-select form-select-sm" 
                                    onchange="cambiarEstado(${pedido.id}, this.value)">
                                <option value="PENDIENTE" ${pedido.estado === 'PENDIENTE' ? 'selected' : ''}>Pendiente</option>
                                <option value="EN_PROCESO" ${pedido.estado === 'EN_PROCESO' ? 'selected' : ''}>En Proceso</option>
                                <option value="ENTREGADO" ${pedido.estado === 'ENTREGADO' ? 'selected' : ''}>Entregado</option>
                            </select>
                        </td>
                        <td>
                            <span class="text-info">
                                <i class="fas fa-motorcycle"></i> Pedro Repartidor
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" 
                                    onclick="verDetalle(${pedido.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <a href="tel:${pedido.telefono}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-phone"></i>
                            </a>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function cambiarEstado(pedidoId, nuevoEstado) {
    if (confirm(`¿Cambiar estado del pedido a "${nuevoEstado}"?`)) {
        // Actualizar en datos locales
        const pedido = allPedidos.find(p => p.id === pedidoId);
        if (pedido) {
            pedido.estado = nuevoEstado;
        }
        
        // Si dataStore está disponible, usarlo también
        if (typeof dataStore !== 'undefined') {
            try {
                dataStore.updatePedidoEstado(pedidoId, nuevoEstado);
            } catch (error) {
                console.log('Actualizando solo datos locales');
            }
        }
        
        loadPedidos(); // Recargar datos
        showNotification(`Estado actualizado a ${nuevoEstado}`, 'success');
    }
}

        function verDetalle(pedidoId) {
            const pedido = allPedidos.find(p => p.id === pedidoId);
            if (!pedido) return;

            const modal = new bootstrap.Modal(document.getElementById('detallePedidoModal'));
            const content = document.getElementById('detallePedidoContent');

            let productosHtml = '';
            pedido.productos.forEach(producto => {
                productosHtml += `
                    <tr>
                        <td>${producto.nombre}</td>
                        <td class="text-center">${producto.cantidad}</td>
                        <td class="text-end">S/. ${producto.precio.toFixed(2)}</td>
                        <td class="text-end"><strong>S/. ${producto.subtotal.toFixed(2)}</strong></td>
                    </tr>
                `;
            });

            const badgeClass = {
                'PENDIENTE': 'warning',
                'EN_PROCESO': 'info',
                'ENTREGADO': 'success'
            }[pedido.estado] || 'secondary';

            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle"></i> Información del Pedido</h6>
                        <table class="table table-sm">
                            <tr><th>N° Pedido:</th><td>${pedido.numero}</td></tr>
                            <tr><th>Fecha:</th><td>${pedido.fecha}</td></tr>
                            <tr><th>Estado:</th><td><span class="badge bg-${badgeClass}">${pedido.estado}</span></td></tr>
                            <tr><th>Total:</th><td><strong>S/. ${pedido.total.toFixed(2)}</strong></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-user"></i> Información del Cliente</h6>
                        <table class="table table-sm">
                            <tr><th>Nombre:</th><td>${pedido.clienteNombre}</td></tr>
                            <tr><th>Teléfono:</th><td>
                                <a href="tel:${pedido.telefono}">${pedido.telefono}</a>
                            </td></tr>
                            <tr><th>Dirección:</th><td>${pedido.direccion}</td></tr>
                            <tr><th>Repartidor:</th><td>Pedro Repartidor</td></tr>
                        </table>
                    </div>
                </div>
                
                <h6 class="mt-4"><i class="fas fa-pills"></i> Productos del Pedido</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Producto</th>
                                <th class="text-center">Cantidad</th>
                                <th class="text-end">Precio Unit.</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productosHtml}
                        </tbody>
                        <tfoot>
                            <tr class="table-success">
                                <th colspan="3" class="text-end">TOTAL:</th>
                                <th class="text-end">S/. ${pedido.total.toFixed(2)}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            modal.show();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('estadoFilter').value = '';
            document.getElementById('fechaFilter').value = '';
            applyFilters();
        }

        function logout() {
            if (confirm('¿Desea cerrar sesión?')) {
                sessionStorage.removeItem('adminUser');
                window.location.href = './index.html';
            }
        }
    </script>
</body>

</html>