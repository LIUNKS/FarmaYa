<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Repartidor - Farmacia Mery Salud</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .delivery-header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .pedido-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .pedido-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
        }
        
        .client-info {
            border-left: 4px solid #28a745;
            padding-left: 15px;
            margin: 15px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .delivery-stats {
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .floating-action {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="container mt-4">
        <div class="delivery-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="fw-bold text-primary mb-0">
                        <i class="fas fa-motorcycle"></i> Panel de Entregas
                    </h2>
                    <p class="text-muted mb-0">Bienvenido, <span id="repartidorName">Pedro Repartidor</span></p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="d-flex justify-content-end gap-3">
                        <button class="btn btn-outline-info" onclick="refreshPedidos()">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle"></i> Mi Cuenta
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="../index.html">
                                    <i class="fas fa-globe"></i> Ver Sitio Público
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="delivery-stats">
                    <h4 class="text-warning" id="pedidosPendientes">0</h4>
                    <small>Pendientes</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="delivery-stats">
                    <h4 class="text-info" id="pedidosEnProceso">0</h4>
                    <small>En Proceso</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="delivery-stats">
                    <h4 class="text-success" id="pedidosEntregados">0</h4>
                    <small>Entregados Hoy</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="delivery-stats">
                    <h4 class="text-primary" id="totalGanancias">S/. 0</h4>
                    <small>Total del Día</small>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-4">
                <select class="form-select" id="estadoFilter" onchange="applyFilters()">
                    <option value="">Todos los estados</option>
                    <option value="PENDING">Pendientes</option>
                    <option value="PROCESSING">En Proceso</option>
                    <option value="DELIVERED">Entregados</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" id="searchInput" 
                       placeholder="Buscar por cliente o N° pedido..." onkeyup="applyFilters()">
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-light w-100" onclick="clearFilters()">
                    <i class="fas fa-times"></i> Limpiar
                </button>
            </div>
        </div>

        <!-- Pedidos List -->
        <div id="pedidosList">
            <!-- Se llenará dinámicamente -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center text-white" style="display: none;">
            <i class="fas fa-clipboard-list fa-5x mb-3 opacity-50"></i>
            <h4>No hay pedidos asignados</h4>
            <p>Los nuevos pedidos aparecerán aquí automáticamente</p>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="floating-action">
        <button class="btn btn-success btn-lg rounded-circle" onclick="refreshPedidos()" title="Actualizar pedidos">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <!-- Modal Cambiar Estado -->
    <div class="modal fade" id="cambiarEstadoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cambiar Estado del Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¿Desea cambiar el estado del pedido <strong id="modalPedidoNumero"></strong>?</p>
                    <div class="mb-3">
                        <label class="form-label">Nuevo Estado:</label>
                        <select class="form-select" id="nuevoEstado">
                            <option value="EN_PROCESO">En Proceso</option>
                            <option value="ENTREGADO">Entregado</option>
                        </select>
                    </div>
                    <div class="mb-3" id="comentarioDiv" style="display: none;">
                        <label class="form-label">Comentario (opcional):</label>
                        <textarea class="form-control" id="comentarioEntrega" rows="3" 
                                  placeholder="Entregado a..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="confirmarCambioEstado()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/api-config.js"></script>
    <script src="../assets/js/data.js"></script>
    <!-- NOTA: app.js no se carga en el panel de delivery para evitar conflictos -->

    <script>
        let allPedidos = [];
        let filteredPedidos = [];
        let selectedPedidoId = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkDeliveryAuth();
            loadPedidos();
            setupEventListeners();
        });

        function checkDeliveryAuth() {
            const usuarioActual = JSON.parse(localStorage.getItem('usuarioActual') || 'null');
            
            if (!usuarioActual || usuarioActual.rol !== 'DELIVERY') {
                window.location.href = '../login.html';
                return;
            }
            
            document.getElementById('repartidorName').textContent = usuarioActual.nombre;
        }

        function setupEventListeners() {
            // Mostrar/ocultar comentario según el estado
            document.getElementById('nuevoEstado').addEventListener('change', function() {
                const comentarioDiv = document.getElementById('comentarioDiv');
                if (this.value === 'DELIVERED') {
                    comentarioDiv.style.display = 'block';
                } else {
                    comentarioDiv.style.display = 'none';
                }
            });
        }

        async function loadPedidos() {
            try {
                // Cargar pedidos asignados
                const pedidosResponse = await OrderAPI.getMyAssignedOrders();
                allPedidos = pedidosResponse.map(pedido => ({
                    id: pedido.id,
                    numero: pedido.numeroPedido,
                    clienteNombre: pedido.user ? pedido.user.username : 'Cliente',
                    telefono: pedido.user ? pedido.user.telefono : '',
                    direccion: pedido.shippingAddress,
                    productos: pedido.items ? pedido.items.map(item => ({
                        id: item.id,
                        nombre: item.product ? item.product.name : 'Producto',
                        cantidad: item.quantity,
                        precio: item.price,
                        subtotal: item.subtotal
                    })) : [],
                    total: pedido.totalAmount,
                    estado: pedido.status,
                    fecha: pedido.createdAt ? new Date(pedido.createdAt[0], pedido.createdAt[1]-1, pedido.createdAt[2]).toLocaleDateString('es-ES') : '',
                    repartidorId: pedido.repartidor ? pedido.repartidor.id : null
                }));

                // Cargar estadísticas
                const statsResponse = await OrderAPI.getDeliveryStats();
                updateStatsFromAPI(statsResponse);

                filteredPedidos = [...allPedidos];
                renderPedidos();
            } catch (error) {
                console.error('Error cargando pedidos:', error);
                showNotification('Error al cargar los pedidos', 'danger');
                
                // Fallback a datos vacíos
                allPedidos = [];
                filteredPedidos = [];
                renderPedidos();
            }
        }

        function updateStatsFromAPI(stats) {
            document.getElementById('pedidosPendientes').textContent = stats.pedidosPendientes || 0;
            document.getElementById('pedidosEnProceso').textContent = stats.pedidosEnProceso || 0;
            document.getElementById('pedidosEntregados').textContent = stats.pedidosEntregados || 0;
            document.getElementById('totalGanancias').textContent = `S/. ${(stats.totalGanancias || 0).toFixed(2)}`;
        }

        function updateStats() {
            // Esta función se mantiene por compatibilidad pero ahora usamos updateStatsFromAPI
            const stats = {
                pedidosPendientes: allPedidos.filter(p => p.estado === 'PENDING').length,
                pedidosEnProceso: allPedidos.filter(p => p.estado === 'PROCESSING').length,
                pedidosEntregados: allPedidos.filter(p => p.estado === 'DELIVERED').length,
                totalGanancias: allPedidos
                    .filter(p => p.estado === 'DELIVERED')
                    .reduce((sum, p) => sum + p.total, 0)
            };
            
            updateStatsFromAPI(stats);
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const estadoFilter = document.getElementById('estadoFilter').value;
            
            filteredPedidos = allPedidos.filter(pedido => {
                const matchSearch = !searchTerm || 
                    pedido.numero.toLowerCase().includes(searchTerm) ||
                    pedido.clienteNombre.toLowerCase().includes(searchTerm);
                
                const matchEstado = !estadoFilter || pedido.estado === estadoFilter;
                
                return matchSearch && matchEstado;
            });
            
            renderPedidos();
        }

        function renderPedidos() {
            const container = document.getElementById('pedidosList');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredPedidos.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            let html = '';
            filteredPedidos.forEach(pedido => {
                const badgeClass = {
                    'PENDING': 'warning',
                    'PROCESSING': 'info',
                    'DELIVERED': 'success'
                }[pedido.estado] || 'secondary';
                
                const statusIcon = {
                    'PENDING': 'clock',
                    'PROCESSING': 'truck',
                    'DELIVERED': 'check-circle'
                }[pedido.estado] || 'question';
                
                const statusText = {
                    'PENDING': 'PENDIENTE',
                    'PROCESSING': 'EN PROCESO',
                    'DELIVERED': 'ENTREGADO'
                }[pedido.estado] || pedido.estado;
                
                html += `
                    <div class="pedido-card position-relative" onclick="verDetalle(${pedido.id})">
                        <span class="badge bg-${badgeClass} status-badge">
                            <i class="fas fa-${statusIcon}"></i> ${statusText}
                        </span>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <h5 class="fw-bold text-primary">${pedido.numero}</h5>
                                <div class="client-info">
                                    <h6 class="mb-1">
                                        <i class="fas fa-user"></i> ${pedido.clienteNombre}
                                    </h6>
                                    <p class="mb-1">
                                        <i class="fas fa-phone text-success"></i> 
                                        <a href="tel:${pedido.telefono}" class="text-decoration-none">
                                            ${pedido.telefono}
                                        </a>
                                    </p>
                                    <p class="mb-1">
                                        <i class="fas fa-map-marker-alt text-danger"></i> 
                                        ${pedido.direccion}
                                    </p>
                                    <p class="mb-0 text-muted">
                                        <i class="fas fa-clock"></i> ${pedido.fecha}
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <h4 class="text-success fw-bold">S/. ${pedido.total.toFixed(2)}</h4>
                                <p class="text-muted">
                                    <i class="fas fa-pills"></i> ${pedido.productos.length} productos
                                </p>
                                
                                <div class="action-buttons" onclick="event.stopPropagation()">
                                    <a href="tel:${pedido.telefono}" class="btn btn-success btn-sm">
                                        <i class="fas fa-phone"></i>
                                    </a>
                                    <a href="https://wa.me/51${pedido.telefono}" target="_blank" class="btn btn-success btn-sm">
                                        <i class="fab fa-whatsapp"></i>
                                    </a>
                                    ${pedido.estado !== 'ENTREGADO' ? 
                                        `<button class="btn btn-primary btn-sm" onclick="cambiarEstado(${pedido.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>` : ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function verDetalle(pedidoId) {
            window.location.href = `./pedido.html?id=${pedidoId}`;
        }

        function cambiarEstado(pedidoId) {
            const pedido = allPedidos.find(p => p.id === pedidoId);
            if (!pedido) return;
            
            selectedPedidoId = pedidoId;
            document.getElementById('modalPedidoNumero').textContent = pedido.numero;
            
            // Configurar opciones según estado actual
            const nuevoEstadoSelect = document.getElementById('nuevoEstado');
            nuevoEstadoSelect.innerHTML = '';
            
            if (pedido.estado === 'PENDING') {
                nuevoEstadoSelect.innerHTML = `
                    <option value="PROCESSING">En Proceso</option>
                    <option value="DELIVERED">Entregado</option>
                `;
            } else if (pedido.estado === 'PROCESSING') {
                nuevoEstadoSelect.innerHTML = `
                    <option value="DELIVERED">Entregado</option>
                `;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('cambiarEstadoModal'));
            modal.show();
        }

        async function confirmarCambioEstado() {
            const nuevoEstado = document.getElementById('nuevoEstado').value;
            
            try {
                await OrderAPI.updateDeliveryStatus(selectedPedidoId, nuevoEstado);
                
                // Recargar pedidos después de actualizar
                await loadPedidos();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('cambiarEstadoModal'));
                modal.hide();
                
                showNotification(`Estado actualizado a ${nuevoEstado}`, 'success');
            } catch (error) {
                console.error('Error actualizando estado:', error);
                showNotification('Error al actualizar el estado del pedido', 'danger');
            }
        }

        async function refreshPedidos() {
            // Simular recarga con animación
            const button = event.target.closest('button');
            const icon = button.querySelector('i');
            
            icon.classList.add('fa-spin');
            
            try {
                await loadPedidos();
                showNotification('Pedidos actualizados', 'info');
            } catch (error) {
                console.error('Error refrescando pedidos:', error);
                showNotification('Error al actualizar pedidos', 'danger');
            } finally {
                icon.classList.remove('fa-spin');
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('estadoFilter').value = '';
            applyFilters();
        }

        function showNotification(message, type) {
            // Crear notificación
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function logout() {
            if (confirm('¿Desea cerrar sesión?')) {
                localStorage.clear();
                window.location.href = '../login.html';
            }
        }
    </script>
</body>
</html>